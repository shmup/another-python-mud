<html>
<head>
<link rel=StyleSheet href="style/style.css" type="text/css" media=screen>
<script type="text/javascript" src="scripts/jquery-1.7.2.min.js"></script> 
<script language = "javascript">
//idea 1: Server sends a "windowed" view of the map. This windowed view is 0 based, regardless of the actual coordinate the user is at
//Sub-idea 1: The server only sends the differences from the last request, not the full map


var map_diff;				

var ws = new WebSocket("ws://localhost:8888/websocket");

ws.onopen = function() {
   ws.send("Nicholas");
   ws.send("a");
   ws.send("l");
};

ws.onmessage = function (evt) {
   if(evt.data.substring(0, 5) == '{"gam')
   {
	map_diff = window.JSON.parse(evt.data)
	change_map()
   }
   if(evt.data.substring(0, 5) == '{"inv')
   {
	inv = window.JSON.parse(evt.data)
	set_inventory(inv);
   }
   
    
};


function get_obj_type(i)
{
	return "sapphire";
}

function set_inventory(inv)
{
	$(".inv-box").html("")
	
	for(i in inv.inv)
	{
		obj_type = i;
		count = inv.inv[i]
		
		$("<div>", {"class":"inv_item "+obj_type}).html(count+"x "+obj_type).appendTo(".inv-box");
	}
}


function handle_key_down(e)
{
	if(e.keyCode == 40)
	{
		ws.send("dig 1 d");
		ws.send("l");
	}
	if(e.keyCode == 37)
	{
		ws.send("dig 1 w");
		ws.send("l");
	}
	if(e.keyCode == 39)
	{
		ws.send("dig 1 e");
		ws.send("l");
	}
}

function change_map(){
	
	var map = map_diff
	for(var tile in map.gamemap)
	{
		
		$("#"+tile).removeClass( "tile0 tile1 tile2 tile3", false )
		$("#"+tile).addClass( "tile"+map.gamemap[tile], true )
	}
}



$(document).ready(function() {
for(var j = 19; j >= 0 ; j--)
{
	$("<div/>", { "class":"tile-row", "id": "row"+j }).appendTo(".map-box");
	for(var i = 0; i < 33; i++)
	{
		if(i == 16 && j == 9)
		{
			$("<div>", {"class":"tile ptile", "id":i+"_"+j}).html("o").appendTo("#row"+j);
			
		}
		else
		{
			$("<div>", {"class":"tile tile0", "id":i+"_"+j}).html("#").appendTo("#row"+j);
		}
	}
}
   

document.getElementById('kinput').onkeydown = handle_key_down;


});

</script>
</head>

<body>
<div class = "container">
<div class = "map-box"></div>
<div class = "inv-box"></div>
</div>
<div class = "chat-box"><input id = "kinput" type="text" size="30"></div>

</body>
</html>